/*! *****************************************************************************
    Copyright (c) Activbody Inc. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs")):"function"==typeof define&&define.amd?define("activ5-device",["exports","rxjs"],e):e(t["activ5-device"]={},t.rxjs)}(this,function(t,r){"use strict";function e(e,c,s,o){return new(s=s||Promise)(function(t,n){function r(t){try{a(o.next(t))}catch(e){n(e)}}function i(t){try{a(o["throw"](t))}catch(e){n(e)}}function a(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,i)}a((o=o.apply(e,c||[])).next())})}function i(r,i){var a,c,s,t,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,c&&(s=2&t[0]?c["return"]:t[0]?c["throw"]||((s=c["return"])&&s.call(c),0):c.next)&&!(s=s.call(c,t[1])).done)return s;switch(c=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,c=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=i.call(r,o)}catch(e){t=[6,e],c=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}var a="00005000-0000-1000-8000-00805f9b34fb",n="00005a01-0000-1000-8000-00805f9b34fb",c="00005a02-0000-1000-8000-00805f9b34fb",s="TVGTIME",o="ISOM!",u="TARE!",h="STOP!",f="handshake",v="isometric",l="stop",d="disconnected",p=(b.prototype.connect=function(){return e(this,void 0,void 0,function(){var e,n,r;return i(this,function(t){switch(t.label){case 0:return window.navigator&&window.navigator.bluetooth?[4,navigator.bluetooth.requestDevice({filters:[{services:[a]}]})]:[3,4];case 1:return[4,(e=t.sent()).gatt.connect()];case 2:return[4,(n=t.sent()).getPrimaryService(a)];case 3:return r=t.sent(),[2,new y(e,n,r)];case 4:return[2]}})})},b);function b(){}var y=(w.prototype.getIsometricData=function(){return this.isomDataAsObservable.asObservable()},w.prototype.onDisconnect=function(){return this.disconnectEventAsObservable.asObservable()},w.prototype.startIsometric=function(){return e(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(o))];case 1:return t.sent(),this.deviceState=v,[4,this.startNotifications()];case 2:return e=t.sent(),this.attachIsometricListener(e),[2]}})})},w.prototype.tare=function(){this.writeCharacteristicValue(this.formatCommand(u))},w.prototype.stop=function(){return e(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(h))];case 1:return t.sent(),this.deviceState=l,[2]}})})},w.prototype.evergreenMode=function(t){var e=this;t?this.evergreenModeTimer=window.setInterval(function(){switch(e.deviceState){case l:case f:e.stop()}},6e4):clearInterval(this.evergreenModeTimer)},w.prototype.disconnect=function(){this.device.gatt.disconnect()},w.prototype.init=function(){return e(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.cacheCharacteristic(n)];case 1:return t.sent(),[4,this.cacheCharacteristic(c)];case 2:return t.sent(),[4,this.writeCharacteristicValue(this.formatCommand(s))];case 3:return t.sent(),this.deviceState=f,this.attachDisconnectListener(),[2]}})})},w.prototype.attachDisconnectListener=function(){var e=this;this.device.addEventListener("gattserverdisconnected",function(t){e.disconnectEventAsObservable.next(t),e.deviceState=d,e.device=undefined,e.server=undefined,e.service=undefined})},w.prototype.cacheCharacteristic=function(n){return e(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,this.service.getCharacteristic(n)];case 1:return e=t.sent(),this.characteristics.set(n,e),[2]}})})},w.prototype.writeCharacteristicValue=function(t){return this.characteristics.get(c).writeValue(t)},w.prototype.startNotifications=function(){return this.characteristics.get(n).startNotifications()},w.prototype.attachIsometricListener=function(t){var n=this;t.addEventListener("characteristicvaluechanged",function(t){var e=t.target;n.parseData(e.value)})},w.prototype.parseData=function(t){var e=String.fromCharCode.apply(null,new Uint8Array(t.buffer)).match(/IS(.*)\/IS/)[1];this.isomDataAsObservable.next(e)},w.prototype.formatCommand=function(t){var e=new ArrayBuffer(t.length+2),n=new DataView(e,0);n.setUint8(0,65);for(var r=0;r<t.length;r++)n.setUint8(r+1,t.charCodeAt(r));return n.setUint8(t.length+1,25),n},w);function w(t,e,n){this.disconnectEventAsObservable=new r.Subject,this.isomDataAsObservable=new r.Subject,this.characteristics=new Map,this.deviceState=d,this.device=t,this.server=e,this.service=n,this.init()}t.A5DeviceManager=p,t.A5Device=y,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=activ5-device.umd.min.js.map